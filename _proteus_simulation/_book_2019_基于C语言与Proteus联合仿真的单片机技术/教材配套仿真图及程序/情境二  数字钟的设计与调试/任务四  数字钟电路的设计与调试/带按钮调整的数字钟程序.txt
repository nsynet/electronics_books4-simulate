//带按钮调整的数字钟程序
//===========声明区========================================================================================
#include <reg51.h>
#define shuma P2            //定义数码管数码端接P2口
#define xuanze P3            //定义数码管控制端接P3口
char code tab[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x98};   //0~9的共阳极驱动码
saomiao( );                  //声明扫描函数
delay(int);                   //声明延时函数
int sec20=0;                 //定义50ms的次数初始值为0
int sec=0;                   //定义秒初始值为0
int min=59;                  //用来存放分钟,初始值为59
int hour=23;                 //用来存放分钟时,初始值为23
sbit  mincon=P1^5;          //分调整按钮
Sbit  hourcon=P1^6;	        //时调整按钮
Sbit  set=P1^7;	             //总设置开关
//===============主程序===================================================================================
main()
{
TH0=(65536-50000)/256;                // 定时器设初始值，定时50ms
TL0=(65536-50000)%256;
TMOD=0x01;                         // 设置定时器0的工作方式为1
EA=1;                               // 开中断总开关
ET0=1;                              // 开定时器中断0开关
TR0=1;                              // 启动定时
while(1)
{ if (set==1)		                 // 如果总设置按钮没按
{TR0=1;		            / / 定时器开
saomiao(  );	            // 调用扫描
}     		 
If (set==0)		            // 如果总设置按钮按下去了
{  TR0=0;		            // 关定时器
	 sec=0;		            // 秒清0
	 saomiao( );             // 调用扫描
             If (mincon==0)	       // 如果分设置按钮按下去了					
 {   delay(20);       // 去抖动
saomiao( );
			   min++;        //分加1
			}
	 If (hourcon==0)	      // 如果是设置按钮按下去了
		   {   delay(20);     // 去抖动
saomiao( );
			  hour++;       // 时加1
		   }
		if(min==60)   
min=0;          // 60秒清零
		if(hour==24)
hour=0;         // 24时清零	       
 }
}
}

//============扫描函数================================================================================
saomiao( )
{  xuanze=0xfe;               // 选择时十位
  shuma=tab[hour/10];         // 显示时十位
  delay(2);
  shuma=0xff;

xuanze=0xfd;               // 选择时个位
  shuma=tab[hour%10];        // 显示时个位
  delay(2);
  shuma=0xff;

xuanze=0xfb;
shuma=0xbf;               // 显示- 
    delay(2);
  shuma=0xff;

xuanze=0xf7;               // 选择分十位
  shuma=tab[min/10];         // 显示分十位
  delay(2);
  shuma=0xff;

  xuanze=0xef;              // 选择分个位
  shuma=tab[min%10];       // 显示分个位
  delay(2); 
  shuma=0xff;

xuanze=0xdf;      
shuma=0xbf;              / /显示- 
  delay(2);
  shuma=0xff;

xuanze=0xbf;               // 选择秒十位
  shuma=tab[sec/10];        // 显示秒十位
  delay(2);
  shuma=0xff;

xuanze=0x7f;              // 选择秒个位
  shuma=tab[sec%10];      // 显示秒个位
  delay(2);
 shuma=0xff;                                     
}
//=============================定时器0中断子程序========================================================
void onesec(void) interrupt 1   
  {   TH0=(65536-50000)/256;	               // 重新加载初始值
TL0=(65536-50000)%256;		  
	sec20++;				      // 每50ms加1
	if(sec20==20)				      // 计到20次，即1秒
		{  sec++;				      // 秒加1
		   sec20=0;				 / /sec20清0
		 }
if(sec==60)					  // 如果60秒时间到
		{  min++;                      // 分加1
		   sec=0;					  // 秒数清0
	   }
        if(min==60)					      // 如果60分时间到
		{ hour++;                      // 时加1
		  min=0;					 // 分数清0
	  }
        if(hour==24)					     // 如果24时到
		{  hour=0;				     // 时清0
	  }
       }
//==========================1ms延时子程序=============================================================
delay(int x)
{   int i,j;
for(i=0;i<x;i++)
for(j=0;j<120;j++);
}