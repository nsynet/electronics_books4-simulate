//-----------------------------------------------------------------
//  名称: TIMER1控制数码管动态管显示
//-----------------------------------------------------------------
//  说明: 8个数码管上分两组动态显示年月日与时分秒,本例的位显示延时
//		 用T1实现,未使用前面案例中常用的延时函数
//	 
//-----------------------------------------------------------------
#include "STC15xxx.h"
#include <intrins.h>
#define u8 	unsigned char
#define u16	unsigned int
//0-9的数码管段码,最后一位是"-"的段码,索引为10
code u8 DSY_CODE[] =
 { 0xC0,0xF9,0xA4,0xB0,0x99,0x92,0x82,0xF8,0x80,0x90,0xBF };
//待显示数据20-12-25与21-57-39(分为两组显示)
code u8 Table_OF_Digits[][8] = {
 {2,0,10,1,2,10,2,5},
 {2,1,10,5,7,10,3,9}
};
u8 i = 0,j = 0; u16 t = 0;
//------------------------------------------------------------------
#define FOSC 11059200L
#define		T1MS (u16)(65536-4000*(FOSC/12/1000000.0))	//12T@11.0592M
//#define	T1MS (u16)(65536-4000*(FOSC/1000000.0))	//1T@11.0592M
//------------------------------------------------------------------
// T1初始化（12T/模式0/16位，4ms@11.0592MHz）
//------------------------------------------------------------------
void Timer1Init() {
	AUXR &= 0xBF;			//定时器时钟12T模式
	TMOD &= 0x0F;			//设置定时器模式0
	TL1 = 0x9A;				//设置定时初值(4毫秒定时)
	TH1 = 0xF1;				//设置定时初值
	//或：
	//TL1 = T1MS & 0xFF;	//4毫秒定时
	//TH1 = T1MS >>8 ;
	//或：
	//TL1 = (u16)(-4000*(FOSC/12/1000000.0)) & 0xFF; //4毫秒定时
	//TH1 = (u16)(-4000*(FOSC/12/1000000.0)) >>8 ;
	TF1 = 0;				//清除TF1标志
	TR1 = 1;				//定时器1开始计时
}
//------------------------------------------------------------------
// 主程序(方法1,使用T1定时器中断控制数码刷新显示)
//------------------------------------------------------------------
void main() {
	P1M1 = 0; P1M0 = 0;	//配置为准双向口
	P2M1 = 0; P2M0 = 0;
	Timer1Init();				//T1初始化
	IE = 0x88;					//使能T1中断，开总中断
	//上面语句还可拆成：ET1 = 1; EA = 1;
	TR1 = 1;						//启动T1
	while(1);						//主程序无限延时,定时器中断持续触发
} 
//------------------------------------------------------------------
// T1中断控制数码管刷新显示
//------------------------------------------------------------------
void DSY_Show() interrupt 3 {


}
/*
//------------------------------------------------------------------
// 主程序(方法2,不使用T1定时器中断控制数码刷新显示)
//------------------------------------------------------------------
void main() {  


}*/